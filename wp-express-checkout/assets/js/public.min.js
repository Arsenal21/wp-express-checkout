var ppecHandler=function(a){this.data=a,this.actions={};var t=this;this.processPayment=function(a,e){jQuery.post(ppecFrontVars.ajaxUrl,{action:e,wp_ppdg_payment:a,data:t.data,nonce:t.data.nonce}).done(function(a){t.completePayment(a)})},this.completePayment=function(a){var e=!0,r=ppecFrontVars.str.paymentCompleted,n=ppecFrontVars.str.redirectMsg;if(a.redirect_url)var i=a.redirect_url;else r=ppecFrontVars.str.errorOccurred,n=a,e=!1;jQuery('.wp-ppec-overlay[data-ppec-button-id="'+t.data.id+'"]').hide();var o=jQuery('<div id="wp-ppdg-dialog-message" title="'+r+'"><p id="wp-ppdg-dialog-msg">'+n+"</p></div>");return jQuery("#"+t.data.id).before(o).fadeIn(),i&&(location.href=i),e},this.ValidatorTos=function(a){return!0!==a.prop("checked")?ppecFrontVars.str.acceptTos:null},this.ValidatorBilling=function(a){var t="checkbox"===a.attr("type")?!0===a.prop("checked"):a.val();return a.is(":visible")&&!t?ppecFrontVars.str.required:null},this.isValidTotal=function(){return t.calcTotal(),!!t.data.total},this.ValidatorQuantity=function(a){var e=a.val(),r=parseInt(e),n=!1;return isNaN(r)||e%1!=0||r<=0?n=ppecFrontVars.str.enterQuantity:t.data.stock_enabled&&r>t.data.stock_items?n=ppecFrontVars.str.stockErr.replace("%d",t.data.stock_items):t.data.quantity=r,n},this.ValidatorAmount=function(a){var e=a.val(),r=parseFloat(e),n=a.attr("min"),i=!1,o=ppecFrontVars.str.enterAmount;return!isNaN(r)&&n<=r?(t.data.orig_price=r,t.data.price=t.applyVariations(r)):i=o,i},"horizontal"===this.data.btnStyle.layout&&(this.data.btnStyle.tagline=!1),this.clientVars={},this.clientVars[this.data.env]=this.data.client_id,this.inputs=[],this.validateInput=function(a,e){if(1>a.length)return!1;this.inputs.push([a,e]),a.change(function(){t.displayInputError(jQuery(this),e),t.validateOrder()})},this.validateOrder=function(){var a=!0;jQuery("#wpec_billing_"+t.data.id+", #place-order-"+t.data.id).toggle(!t.isValidTotal()),jQuery("#"+t.data.id).toggle(!jQuery("#place-order-"+t.data.id).is(":visible")),t.inputs.forEach(function(t){var e=t[0];(0,t[1])(e)&&(a=!1)}),t.isValidTotal()||(a=!1),a?t.actions.enable():t.actions.disable(),t.updateAllAmounts(),jQuery(document).trigger("wpec_validate_order",[t])},this.displayInputError=function(a,t){var e=t(a),r=a.is(":checkbox")||"number"===a.attr("type")?a.parent().siblings(".wp-ppec-form-error-msg"):a.siblings(".wp-ppec-form-error-msg");a.toggleClass("hasError",!!e),r.html(e),e&&r.length?r.fadeIn("slow"):r.fadeOut("fast")},this.displayErrors=function(){t.inputs.forEach(function(a){t.displayInputError(a[0],a[1])})},this.scCont=jQuery('.wp-ppec-shortcode-container[data-ppec-button-id="'+t.data.id+'"]'),this.buttonArgs={env:t.data.env,client:t.clientVars,style:t.data.btnStyle,commit:!0,onInit:function(a,e){if(t.actions=e,t.validateInput(jQuery("#wpec-tos-"+t.data.id),t.ValidatorTos),t.validateInput(jQuery('#wp-ppec-custom-quantity[data-ppec-button-id="'+t.data.id+'"]'),t.ValidatorQuantity),t.validateInput(jQuery('#wp-ppec-custom-amount[data-ppec-button-id="'+t.data.id+'"]'),t.ValidatorAmount),jQuery("#wpec_billing_"+t.data.id+" .wpec_required").each(function(){t.validateInput(jQuery(this),t.ValidatorBilling)}),t.data.orig_price=parseFloat(t.data.price),t.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio").change(function(){var a=jQuery(this).data("wpec-variations-group-id"),e=jQuery(this).val();0!==Object.getOwnPropertyNames(t.data.variations).length&&(t.data.variations.applied||(t.data.variations.applied=[]),t.data.variations.applied[a]=e,t.data.price=t.applyVariations(t.data.orig_price),t.validateOrder())}),t.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio:checked").change(),t.scCont.find(".wpec_product_shipping_enable").change(function(){t.scCont.find(".wpec_shipping_address_container").toggle(),t.scCont.find(".wpec_address_wrap").toggleClass("shipping_enabled")}),jQuery("#place-order-"+t.data.id).click(function(){t.buttonArgs.onClick()}),jQuery("#wpec-redeem-coupon-btn-"+t.data.id).click(function(a){a.preventDefault();var e=jQuery(this).siblings("#wpec-coupon-field-"+t.data.id).val();if(""===e)return!1;var r=jQuery(this),n=r.find("svg");r.prop("disabled",!0),n.show();var i={action:"wpec_check_coupon",product_id:t.data.product_id,coupon_code:e,curr:t.data.currency};jQuery.post(ppecFrontVars.ajaxUrl,i,function(a){if(a.success){t.data.discount=a.discount,t.data.discountType=a.discountType,t.data.couponCode=a.code,jQuery("#wpec-coupon-info-"+t.data.id).html('<span class="wpec_coupon_code">'+a.discountStr+'</span> <button class="wpec_coupon_apply_btn" id="wpec-remove-coupon-'+t.data.id+'" title="'+ppecFrontVars.str.strRemoveCoupon+'">'+ppecFrontVars.str.strRemove+"</button>"),jQuery("#wpec-redeem-coupon-btn-"+t.data.id).hide(),jQuery("#wpec-coupon-field-"+t.data.id).hide();var e,i,o,d,c=t.getPriceContainer();0!==c.find(".wpec_price_full_total").length?(e=c.children().find("span.wpec_tot_current_price").addClass("wpec_line_through"),i=c.children().find("span.wpec_tot_new_price")):(e=c.find("span.wpec_price_amount").addClass("wpec_line_through"),i=c.find("span.wpec_new_price_amount")),o=c.find("span.wpec-price-amount").addClass("wpec_line_through"),d=c.find("span.wpec-new-price-amount"),t.validateOrder(),jQuery("#wpec-remove-coupon-"+t.data.id).on("click",function(a){a.preventDefault(),jQuery("#wpec-coupon-info-"+t.data.id).html(""),jQuery("#wpec-coupon-field-"+t.data.id).val(""),jQuery("#wpec-coupon-field-"+t.data.id).show(),jQuery("#wpec-redeem-coupon-btn-"+t.data.id).show(),e.removeClass("wpec_line_through"),o.removeClass("wpec_line_through"),i.html(""),d.html(""),delete t.data.discount,delete t.data.discountType,delete t.data.couponCode,delete t.data.discountAmount,delete t.data.newPrice,t.validateOrder()})}else jQuery("#wpec-coupon-info-"+t.data.id).html(a.msg);n.hide(),r.prop("disabled",!1)})}),jQuery("#wpec-coupon-field-"+t.data.id).keydown(function(a){if(13===a.keyCode)return a.preventDefault(),jQuery("#wpec-redeem-coupon-btn-"+t.data.id).click(),!1}),t.validateOrder(),t.data.errors){var r=jQuery('<div class="wp-ppec-form-error-msg">'+t.data.errors+"</div>");t.scCont.append(r),r.show()}jQuery(".wpec-button-placeholder").remove()},onClick:function(){jQuery("#place-order-"+t.data.id).find("button>svg").show(),jQuery("#place-order-"+t.data.id).find("button").attr("disabled",!0),t.displayErrors();var a=t.scCont.find(".hasError").first();a.length>0?(a.focus(),a.trigger("change"),jQuery("#place-order-"+t.data.id).find("button>svg").hide(),jQuery("#place-order-"+t.data.id).find("button").attr("disabled",!1)):t.data.total||t.processPayment({payer:{name:{given_name:jQuery("#wpec_billing_first_name-"+t.data.id).val(),surname:jQuery("#wpec_billing_last_name-"+t.data.id).val()},email_address:jQuery("#wpec_billing_email-"+t.data.id).val(),address:{address_line_1:jQuery("#wpec_billing_address-"+t.data.id).val(),admin_area_1:jQuery("#wpec_billing_state-"+t.data.id).val(),admin_area_2:jQuery("#wpec_billing_city-"+t.data.id).val(),postal_code:jQuery("#wpec_billing_postal_code-"+t.data.id).val(),country_code:jQuery("#wpec_billing_country-"+t.data.id).val()},shipping_address:{address_line_1:jQuery("#wpec_shipping_address-"+t.data.id).val(),admin_area_1:jQuery("#wpec_shipping_state-"+t.data.id).val(),admin_area_2:jQuery("#wpec_shipping_city-"+t.data.id).val(),postal_code:jQuery("#wpec_shipping_postal_code-"+t.data.id).val(),country_code:jQuery("#wpec_shipping_country-"+t.data.id).val()}}},"wpec_process_empty_payment")},createOrder:async function(a,e){t.calcTotal();let r=(t.data.price*t.data.quantity).toFixed(2),n=parseFloat(r),i="NO_SHIPPING";""===t.data.shipping&&!0!==t.data.shipping_enable||(console.log("The physical product checkbox is enabled or there is shipping value has been configured. Setting the shipping preference to collect shipping."),i="GET_FROM_FILE");var o={intent:"CAPTURE",payment_source:{paypal:{experience_context:{payment_method_preference:"IMMEDIATE_PAYMENT_REQUIRED",shipping_preference:i,user_action:"PAY_NOW"}}},purchase_units:[{amount:{value:t.data.total,currency_code:t.data.currency,breakdown:{item_total:{currency_code:t.data.currency,value:n}}},items:[{name:t.data.name,quantity:t.data.quantity,unit_amount:{value:t.data.price,currency_code:t.data.currency}}]}]};t.data.tax&&(o.purchase_units[0].amount.breakdown.tax_total={currency_code:t.data.currency,value:t.PHP_round(t.data.tax_amount*t.data.quantity,t.data.dec_num)},o.purchase_units[0].items[0].tax={currency_code:t.data.currency,value:t.data.tax_amount}),t.data.shipping&&(o.purchase_units[0].amount.breakdown.shipping={currency_code:t.data.currency,value:t.getTotalShippingCost()}),t.data.discount&&(o.purchase_units[0].amount.breakdown.discount={currency_code:t.data.currency,value:parseFloat(t.data.discountAmount)});let d=wpec_create_order_vars.nonce,c=t.data,p="action=wpec_pp_create_order&data="+JSON.stringify(o)+"&wpec_data="+JSON.stringify(c)+"&_wpnonce="+d;try{const a=await fetch(ppecFrontVars.ajaxUrl,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:p}),t=await a.json();if(t.order_id)return console.log("Create-order API call to PayPal completed successfully."),t.order_id;{const a=t.err_msg;throw console.error("Error occurred during create-order call to PayPal. "+a),new Error(a)}}catch(a){console.error(a.message),alert("Could not initiate PayPal Checkout...\n\n"+a.message)}},onApprove:async function(a,e){jQuery('div.wp-ppec-overlay[data-ppec-button-id="'+t.data.id+'"]').css("display","flex"),console.log("Setting up the AJAX request for capture-order call.");let r={};r.order_id=a.orderID;let n=t.data,i=wpec_on_approve_vars.nonce,o="action=wpec_pp_capture_order&data="+JSON.stringify(r)+"&wpec_data="+JSON.stringify(n)+"&_wpnonce="+i;try{const a=await fetch(ppecFrontVars.ajaxUrl,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}),e=await a.json();console.log("Capture-order API call to PayPal completed successfully."),t.completePayment(e)}catch(a){console.error(a),alert("PayPal returned an error! Transaction could not be processed. Enable the debug logging feature to get more details...\n\n"+JSON.stringify(a))}},onError:function(a){jQuery("#place-order-"+t.data.id).find("button>svg").hide(),jQuery("#place-order-"+t.data.id).find("button").attr("disabled",!1),alert(a)}},this.formatMoney=function(a){var e=isNaN(e=Math.abs(t.data.dec_num))?2:t.data.dec_num,r=t.data.dec_sep||".",n=t.data.thousand_sep||",",i=a<0?"-":"",o=String(parseInt(a=Math.abs(Number(a)||0).toFixed(e))),d=o.length,c=d>3?d%3:0,p=i+(c?o.substr(0,c)+n:"")+o.substr(c).replace(/(\d{3})(?=\d)/g,"$1"+n)+(e?r+Math.abs(a-o).toFixed(e).slice(2):"");return{left:"{symbol}{price}",left_space:"{symbol} {price}",right:"{price}{symbol}",right_space:"{price} {symbol}"}[t.data.curr_pos].replace("{symbol}",t.data.currency_symbol).replace("{price}",p)},this.getPriceContainer=function(){return jQuery("."+t.scCont.data("price-class"))},this.updateAllAmounts=function(){t.calcTotal();var a=t.getPriceContainer();if(a.length>0){var e=a.find(".wpec-price-amount");e.length>0&&e.html(t.formatMoney(t.data.price)),t.data.quantity>1?(a.find(".wpec-quantity").show(),a.find(".wpec-quantity-val").html(t.data.quantity)):a.find(".wpec-quantity").hide();var r=a.find(".wpec_tot_current_price"),n=a.find(".wpec_tot_new_price"),i=a.find(".wpec-new-price-amount"),o=a.find(".wpec_price_shipping_amount");void 0!==t.data.discountAmount?(i.html(t.formatMoney(t.data.newPrice)),n.html(t.formatMoney(t.data.total)),r.html(t.formatMoney(t.data.subtotal))):r.length>0&&r.html(t.formatMoney(t.data.total)),o.html(t.formatMoney(t.getTotalShippingCost()));var d=a.find(".wpec-tax-val");d.length>0&&d.html(t.formatMoney(t.data.tax_amount*t.data.quantity))}jQuery(document).trigger("wpec_after_update_all_amounts",[t])},this.calcTotal=function(){var e=parseFloat(t.data.price),r=parseInt(t.data.quantity),n=e*r;let i=n.toFixed(2);var o=n=parseFloat(i);if(t.data.newPrice=e,void 0!==t.data.discount){var d=0;(d="perc"===t.data.discountType?t.PHP_round(n*t.data.discount/100,t.data.dec_num):a.discount)>n&&(d=n),n-=d,t.data.discountAmount=t.PHP_round(d,t.data.dec_num),t.data.newPrice=t.PHP_round(e-d/r,t.data.dec_num)}if(t.data.tax){var c=t.PHP_round(n/r*t.data.tax/100,t.data.dec_num);t.data.tax_amount=c,n+=c*t.data.quantity,o+=t.PHP_round(o/r*t.data.tax/100,t.data.dec_num)*t.data.quantity}const p=t.getTotalShippingCost();p&&(n+=parseFloat(p),o+=parseFloat(p)),t.data.total=t.PHP_round(n,t.data.dec_num),t.data.subtotal=t.PHP_round(o,t.data.dec_num)},this.PHP_round=function(a,t){return Math.round(a*Math.pow(10,t))/Math.pow(10,t)},this.applyVariations=function(a){var e;if(t.data.variations.applied)for(e=0;e<t.data.variations.applied.length;++e){var r=t.data.variations[e];a+=parseFloat(r.prices[t.data.variations.applied[e]])}return t.PHP_round(a,t.data.dec_num)},this.getTotalShippingCost=function(){let a=0;const e=t.data.quantity?parseInt(t.data.quantity):1;return a=(t.data.shipping?parseFloat(t.data.shipping):0)+(t.data.shipping_per_quantity?parseFloat(t.data.shipping_per_quantity):0)*e,a=parseFloat(a.toFixed(2))},jQuery(document).trigger("wpec_before_render_button",[this]),paypal.Buttons(this.buttonArgs).render("#"+t.data.id)},wpecModal=function(a){var t=!1;function e(a){t=a=a||t;var e=document.getElementById(a);e.classList.toggle("wpec-opacity-0"),e.classList.toggle("wpec-pointer-events-none")}a(".wpec-modal-open, .wpec-modal-overlay, .wpec-modal-close").on("click",function(t){t.preventDefault(),e(a(this).data("wpec-modal"))}),document.onkeydown=function(a){("key"in(a=a||window.event)?"Escape"===a.key||"Esc"===a.key:27===a.keyCode)&&t&&e()},a(".wpec-custom-number-input button").on("click",function(){var t="increment"===a(this).data("action")?1:-1,e=a(this).parent().find("input"),r=e.attr("step")?Number(e.attr("step")):1;e.val(Number(e.val())+t*r).change()}),a("#wpec-sort-by").change(function(){a("#wpec-sort-by-form").submit()})};jQuery(wpecModal);