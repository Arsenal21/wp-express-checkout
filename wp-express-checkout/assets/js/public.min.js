var ppecHandler=function(a){this.data=a,this.actions={};var b=this;this.processPayment=function(a,c){jQuery.post(ppecFrontVars.ajaxUrl,{action:c,wp_ppdg_payment:a,data:b.data,nonce:b.data.nonce}).done(function(a){b.completePayment(a)})},this.completePayment=function(a){var c=!0,d=ppecFrontVars.str.paymentCompleted,e=ppecFrontVars.str.redirectMsg;if(a.redirect_url)var f=a.redirect_url;else d=ppecFrontVars.str.errorOccurred,e=a,c=!1;jQuery('.wp-ppec-overlay[data-ppec-button-id="'+b.data.id+'"]').hide();var g=jQuery('<div id="wp-ppdg-dialog-message" title="'+d+'"><p id="wp-ppdg-dialog-msg">'+e+"</p></div>");return jQuery("#"+b.data.id).before(g).fadeIn(),f&&(location.href=f),c},this.ValidatorTos=function(a){return a.prop("checked")!==!0?ppecFrontVars.str.acceptTos:null},this.ValidatorBilling=function(a){var b="checkbox"===a.attr("type")?a.prop("checked")===!0:a.val();return a.is(":visible")&&!b?ppecFrontVars.str.required:null},this.isValidTotal=function(){return b.calcTotal(),!!b.data.total},this.ValidatorQuantity=function(a){var c=a.val(),d=parseInt(c),e=!1;return isNaN(d)||c%1!==0||d<=0?e=ppecFrontVars.str.enterQuantity:b.data.quantity=d,e},this.ValidatorAmount=function(a){var c=a.val(),d=parseFloat(c),e=a.attr("min"),f=!1,g=ppecFrontVars.str.enterAmount;return!isNaN(d)&&e<=d?(b.data.orig_price=d,b.data.price=b.applyVariations(d)):f=g,f},"horizontal"===this.data.btnStyle.layout&&(this.data.btnStyle.tagline=!1),this.clientVars={},this.clientVars[this.data.env]=this.data.client_id,this.inputs=[],this.validateInput=function(a,c){return!(1>a.length)&&(this.inputs.push([a,c]),void a.change(function(){b.displayInputError(jQuery(this),c),b.validateOrder()}))},this.validateOrder=function(){var a=!0;jQuery("#wpec_billing_"+b.data.id+", #place-order-"+b.data.id).toggle(!b.isValidTotal()),jQuery("#"+b.data.id).toggle(!jQuery("#place-order-"+b.data.id).is(":visible")),b.inputs.forEach(function(b){var c=b[0],d=b[1];d(c)&&(a=!1)}),b.isValidTotal()||(a=!1),a?b.actions.enable():b.actions.disable(),b.updateAllAmounts(),jQuery(document).trigger("wpec_validate_order",[b])},this.displayInputError=function(a,b){var c=b(a),d=a.is(":checkbox")||"number"===a.attr("type")?a.parent().siblings(".wp-ppec-form-error-msg"):a.siblings(".wp-ppec-form-error-msg");a.toggleClass("hasError",!!c),d.html(c),c&&d.length?d.fadeIn("slow"):d.fadeOut("fast")},this.displayErrors=function(){b.inputs.forEach(function(a){b.displayInputError(a[0],a[1])})},this.scCont=jQuery('.wp-ppec-shortcode-container[data-ppec-button-id="'+b.data.id+'"]'),this.buttonArgs={env:b.data.env,client:b.clientVars,style:b.data.btnStyle,commit:!0,onInit:function(a,c){if(b.actions=c,b.validateInput(jQuery("#wpec-tos-"+b.data.id),b.ValidatorTos),b.validateInput(jQuery('#wp-ppec-custom-quantity[data-ppec-button-id="'+b.data.id+'"]'),b.ValidatorQuantity),b.validateInput(jQuery('#wp-ppec-custom-amount[data-ppec-button-id="'+b.data.id+'"]'),b.ValidatorAmount),jQuery("#wpec_billing_"+b.data.id+" .wpec_required").each(function(){b.validateInput(jQuery(this),b.ValidatorBilling)}),b.data.orig_price=parseFloat(b.data.price),b.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio").change(function(){var a=jQuery(this).data("wpec-variations-group-id"),c=jQuery(this).val();0!==Object.getOwnPropertyNames(b.data.variations).length&&(b.data.variations.applied||(b.data.variations.applied=[]),b.data.variations.applied[a]=c,b.data.price=b.applyVariations(b.data.orig_price),b.validateOrder())}),b.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio:checked").change(),b.scCont.find(".wpec_product_shipping_enable").change(function(){b.scCont.find(".wpec_shipping_address_container").toggle(),b.scCont.find(".wpec_address_wrap").toggleClass("shipping_enabled")}),jQuery("#place-order-"+b.data.id).click(function(){b.buttonArgs.onClick()}),jQuery("#wpec-redeem-coupon-btn-"+b.data.id).click(function(a){a.preventDefault();var c=jQuery(this).siblings("#wpec-coupon-field-"+b.data.id).val();if(""===c)return!1;var d=jQuery(this),e=d.find("svg");d.prop("disabled",!0),e.show();var f={action:"wpec_check_coupon",product_id:b.data.product_id,coupon_code:c,curr:b.data.currency};jQuery.post(ppecFrontVars.ajaxUrl,f,function(a){if(a.success){b.data.discount=a.discount,b.data.discountType=a.discountType,b.data.couponCode=a.code,jQuery("#wpec-coupon-info-"+b.data.id).html('<span class="wpec_coupon_code">'+a.discountStr+'</span> <button class="wpec_coupon_apply_btn" id="wpec-remove-coupon-'+b.data.id+'" title="'+ppecFrontVars.str.strRemoveCoupon+'">'+ppecFrontVars.str.strRemove+"</button>"),jQuery("#wpec-redeem-coupon-btn-"+b.data.id).hide(),jQuery("#wpec-coupon-field-"+b.data.id).hide();var c,f,g,h,i=jQuery('.wp-ppec-shortcode-container[data-ppec-button-id="'+b.data.id+'"]').closest(".wpec-product-item, .wpec-post-item").find(".wpec-price-container");0!==i.find(".wpec_price_full_total").length?(c=i.children().find("span.wpec_tot_current_price").addClass("wpec_line_through"),f=i.children().find("span.wpec_tot_new_price")):(c=i.find("span.wpec_price_amount").addClass("wpec_line_through"),f=i.find("span.wpec_new_price_amount")),g=i.find("span.wpec-price-amount").addClass("wpec_line_through"),h=i.find("span.wpec-new-price-amount"),b.validateOrder(),jQuery("#wpec-remove-coupon-"+b.data.id).on("click",function(a){a.preventDefault(),jQuery("#wpec-coupon-info-"+b.data.id).html(""),jQuery("#wpec-coupon-field-"+b.data.id).val(""),jQuery("#wpec-coupon-field-"+b.data.id).show(),jQuery("#wpec-redeem-coupon-btn-"+b.data.id).show(),c.removeClass("wpec_line_through"),g.removeClass("wpec_line_through"),f.html(""),h.html(""),delete b.data.discount,delete b.data.discountType,delete b.data.couponCode,delete b.data.discountAmount,delete b.data.newPrice,b.validateOrder()})}else jQuery("#wpec-coupon-info-"+b.data.id).html(a.msg);e.hide(),d.prop("disabled",!1)})}),jQuery("#wpec-coupon-field-"+b.data.id).keydown(function(a){if(13===a.keyCode)return a.preventDefault(),jQuery("#wpec-redeem-coupon-btn-"+b.data.id).click(),!1}),b.validateOrder(),b.data.errors){var d=jQuery('<div class="wp-ppec-form-error-msg">'+b.data.errors+"</div>");b.scCont.append(d),d.show()}jQuery(".wpec-button-placeholder").remove()},onClick:function(){b.displayErrors();var a=b.scCont.find(".hasError").first();a.length>0?(a.focus(),a.trigger("change")):b.data.total||b.processPayment({payer:{name:{given_name:jQuery("#wpec_billing_first_name-"+b.data.id).val(),surname:jQuery("#wpec_billing_last_name-"+b.data.id).val()},email_address:jQuery("#wpec_billing_email-"+b.data.id).val(),address:{address_line_1:jQuery("#wpec_billing_address-"+b.data.id).val(),admin_area_1:jQuery("#wpec_billing_state-"+b.data.id).val(),admin_area_2:jQuery("#wpec_billing_city-"+b.data.id).val(),postal_code:jQuery("#wpec_billing_postal_code-"+b.data.id).val(),country_code:jQuery("#wpec_billing_country-"+b.data.id).val()},shipping_address:{address_line_1:jQuery("#wpec_shipping_address-"+b.data.id).val(),admin_area_1:jQuery("#wpec_shipping_state-"+b.data.id).val(),admin_area_2:jQuery("#wpec_shipping_city-"+b.data.id).val(),postal_code:jQuery("#wpec_shipping_postal_code-"+b.data.id).val(),country_code:jQuery("#wpec_shipping_country-"+b.data.id).val()}}},"wpec_process_empty_payment")},createOrder:function(a,c){b.calcTotal();var d={application_context:{shipping_preference:b.data.shipping_enable?"GET_FROM_FILE":"NO_SHIPPING"},purchase_units:[{amount:{value:b.data.total,currency_code:b.data.currency,breakdown:{item_total:{currency_code:b.data.currency,value:b.data.price*b.data.quantity}}},items:[{name:b.data.name,quantity:b.data.quantity,category:b.data.shipping_enable?"PHYSICAL_GOODS":"DIGITAL_GOODS",unit_amount:{value:b.data.price,currency_code:b.data.currency}}]}]};return b.data.tax&&(d.purchase_units[0].amount.breakdown.tax_total={currency_code:b.data.currency,value:b.PHP_round(b.data.tax_amount*b.data.quantity,b.data.dec_num)},d.purchase_units[0].items[0].tax={currency_code:b.data.currency,value:b.data.tax_amount}),b.data.shipping&&(d.purchase_units[0].amount.breakdown.shipping={currency_code:b.data.currency,value:parseFloat(b.data.shipping)}),b.data.discount&&(d.purchase_units[0].amount.breakdown.discount={currency_code:b.data.currency,value:parseFloat(b.data.discountAmount)}),c.order.create(d)},onApprove:function(a,c){return jQuery('div.wp-ppec-overlay[data-ppec-button-id="'+b.data.id+'"]').css("display","flex"),c.order.capture().then(function(a){b.processPayment(a,"wpec_process_payment")})},onError:function(a){alert(a)}},this.formatMoney=function(a){var c=isNaN(c=Math.abs(b.data.dec_num))?2:b.data.dec_num,d=void 0==d?".":b.data.dec_sep,e=void 0==e?",":b.data.thousand_sep,f=a<0?"-":"",g=String(parseInt(a=Math.abs(Number(a)||0).toFixed(c))),h=(h=g.length)>3?h%3:0,i=f+(h?g.substr(0,h)+e:"")+g.substr(h).replace(/(\d{3})(?=\d)/g,"$1"+e)+(c?d+Math.abs(a-g).toFixed(c).slice(2):""),j={left:"{symbol}{price}",left_space:"{symbol} {price}",right:"{price}{symbol}",right_space:"{price} {symbol}"};return i=j[b.data.curr_pos].replace("{symbol}",b.data.currency_symbol).replace("{price}",i)},this.updateAllAmounts=function(){b.calcTotal();var a=jQuery('.wp-ppec-shortcode-container[data-ppec-button-id="'+b.data.id+'"]').closest(".wpec-product-item, .wpec-post-item").find(".wpec-price-container");if(a.length>0){var c=a.find(".wpec-price-amount");c.length>0&&c.html(b.formatMoney(b.data.price)),b.data.quantity>1?(a.find(".wpec-quantity").show(),a.find(".wpec-quantity-val").html(b.data.quantity)):a.find(".wpec-quantity").hide();var d=a.find(".wpec_tot_current_price"),e=a.find(".wpec_tot_new_price"),f=a.find(".wpec-new-price-amount");"undefined"!=typeof b.data.discountAmount&&d.length>0?(f.html(b.formatMoney(b.data.newPrice)),e.html(b.formatMoney(b.data.total)),d.html(b.formatMoney(b.data.subtotal))):d.length>0&&d.html(b.formatMoney(b.data.total));var g=a.find(".wpec-tax-val");g.length>0&&g.html(b.formatMoney(b.data.tax_amount*b.data.quantity))}jQuery(document).trigger("wpec_after_update_all_amounts",[b])},this.calcTotal=function(){var c=parseFloat(b.data.price),d=parseInt(b.data.quantity),e=c*d,f=e;if(b.data.newPrice=c,"undefined"!=typeof b.data.discount){var g=0;g="perc"===b.data.discountType?b.PHP_round(e*b.data.discount/100,b.data.dec_num):a.discount,e-=g,b.data.discountAmount=b.PHP_round(g,b.data.dec_num),b.data.newPrice=b.PHP_round(c-g/d,b.data.dec_num)}if(b.data.tax){var h=b.PHP_round(e/d*b.data.tax/100,b.data.dec_num);b.data.tax_amount=h,e+=h*b.data.quantity,f+=b.PHP_round(f/d*b.data.tax/100,b.data.dec_num)*b.data.quantity}b.data.shipping&&(e+=parseFloat(b.data.shipping),f+=parseFloat(b.data.shipping)),b.data.total=b.PHP_round(e,b.data.dec_num),b.data.subtotal=b.PHP_round(f,b.data.dec_num)},this.PHP_round=function(a,b){return Math.round(a*Math.pow(10,b))/Math.pow(10,b)},this.applyVariations=function(a){var c;if(b.data.variations.applied)for(c=0;c<b.data.variations.applied.length;++c){var d=b.data.variations[c];a+=parseFloat(d.prices[b.data.variations.applied[c]])}return b.PHP_round(a,b.data.dec_num)},jQuery(document).trigger("wpec_before_render_button",[this]),paypal.Buttons(this.buttonArgs).render("#"+b.data.id)},wpecModal=function(a){function b(a){a=a?a:c,c=a;var b=document.getElementById(a);b.classList.toggle("wpec-opacity-0"),b.classList.toggle("wpec-pointer-events-none")}var c=!1;a(".wpec-modal-open, .wpec-modal-overlay, .wpec-modal-close").on("click",function(){event.preventDefault(),b(a(this).data("wpec-modal"))}),document.onkeydown=function(a){a=a||window.event;var d=!1;d="key"in a?"Escape"===a.key||"Esc"===a.key:27===a.keyCode,d&&c&&b()},a(".wpec-custom-number-input button").on("click",function(){var b="increment"===a(this).data("action")?1:-1,c=a(this).parent().find("input"),d=c.attr("step")?Number(c.attr("step")):1;c.val(Number(c.val())+b*d).change()})};jQuery(wpecModal);