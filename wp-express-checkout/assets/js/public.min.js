var ppecHandler=function(t){this.data=t,this.actions={};var a=this;this.processPayment=function(t,e){jQuery.post(ppecFrontVars.ajaxUrl,{action:e,wp_ppdg_payment:t,data:a.data,nonce:a.data.nonce}).done(function(t){a.completePayment(t)})},this.completePayment=function(t){var e=!0,n=ppecFrontVars.str.paymentCompleted,r=ppecFrontVars.str.redirectMsg;if(t.redirect_url)var i=t.redirect_url;else n=ppecFrontVars.str.errorOccurred,r=t,e=!1;jQuery('.wp-ppec-overlay[data-ppec-button-id="'+a.data.id+'"]').hide();var o=jQuery('<div id="wp-ppdg-dialog-message" title="'+n+'"><p id="wp-ppdg-dialog-msg">'+r+"</p></div>");return jQuery("#"+a.data.id).before(o).fadeIn(),i&&(location.href=i),e},this.ValidatorTos=function(t){return!0!==t.prop("checked")?ppecFrontVars.str.acceptTos:null},this.ValidatorBilling=function(t){var a="checkbox"===t.attr("type")?!0===t.prop("checked"):t.val();return t.is(":visible")&&!a?ppecFrontVars.str.required:null},this.isValidTotal=function(){return a.calcTotal(),!!a.data.total},this.ValidatorQuantity=function(t){var e=t.val(),n=parseInt(e),r=!1;return isNaN(n)||e%1!=0||n<=0?r=ppecFrontVars.str.enterQuantity:a.data.stock_enabled&&n>a.data.stock_items?r=ppecFrontVars.str.stockErr.replace("%d",a.data.stock_items):a.data.quantity=n,r},this.ValidatorAmount=function(t){var e=t.val(),n=parseFloat(e),r=t.attr("min"),i=!1,o=ppecFrontVars.str.enterAmount;return!isNaN(n)&&r<=n?(a.data.orig_price=n,a.data.price=a.applyVariations(n)):i=o,i},"horizontal"===this.data.btnStyle.layout&&(this.data.btnStyle.tagline=!1),this.clientVars={},this.clientVars[this.data.env]=this.data.client_id,this.inputs=[],this.validateInput=function(t,e){if(1>t.length)return!1;this.inputs.push([t,e]),t.change(function(){a.displayInputError(jQuery(this),e),a.validateOrder()})},this.validateOrder=function(){var t=!0;jQuery("#wpec_billing_"+a.data.id+", #place-order-"+a.data.id).toggle(!a.isValidTotal()),jQuery("#"+a.data.id).toggle(!jQuery("#place-order-"+a.data.id).is(":visible")),a.inputs.forEach(function(a){var e=a[0];(0,a[1])(e)&&(t=!1)}),a.isValidTotal()||(t=!1),t?a.actions.enable():a.actions.disable(),a.updateAllAmounts(),jQuery(document).trigger("wpec_validate_order",[a])},this.displayInputError=function(t,a){var e=a(t),n=t.is(":checkbox")||"number"===t.attr("type")?t.parent().siblings(".wp-ppec-form-error-msg"):t.siblings(".wp-ppec-form-error-msg");t.toggleClass("hasError",!!e),n.html(e),e&&n.length?n.fadeIn("slow"):n.fadeOut("fast")},this.displayErrors=function(){a.inputs.forEach(function(t){a.displayInputError(t[0],t[1])})},this.scCont=jQuery('.wp-ppec-shortcode-container[data-ppec-button-id="'+a.data.id+'"]'),this.buttonArgs={env:a.data.env,client:a.clientVars,style:a.data.btnStyle,commit:!0,onInit:function(t,e){if(a.actions=e,a.validateInput(jQuery("#wpec-tos-"+a.data.id),a.ValidatorTos),a.validateInput(jQuery('#wp-ppec-custom-quantity[data-ppec-button-id="'+a.data.id+'"]'),a.ValidatorQuantity),a.validateInput(jQuery('#wp-ppec-custom-amount[data-ppec-button-id="'+a.data.id+'"]'),a.ValidatorAmount),jQuery("#wpec_billing_"+a.data.id+" .wpec_required").each(function(){a.validateInput(jQuery(this),a.ValidatorBilling)}),a.data.orig_price=parseFloat(a.data.price),a.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio").change(function(){var t=jQuery(this).data("wpec-variations-group-id"),e=jQuery(this).val();0!==Object.getOwnPropertyNames(a.data.variations).length&&(a.data.variations.applied||(a.data.variations.applied=[]),a.data.variations.applied[t]=e,a.data.price=a.applyVariations(a.data.orig_price),a.validateOrder())}),a.scCont.find("select.wpec-product-variations-select, input.wpec-product-variations-select-radio:checked").change(),a.scCont.find(".wpec_product_shipping_enable").change(function(){a.scCont.find(".wpec_shipping_address_container").toggle(),a.scCont.find(".wpec_address_wrap").toggleClass("shipping_enabled")}),jQuery("#place-order-"+a.data.id).click(function(){a.buttonArgs.onClick()}),jQuery("#wpec-redeem-coupon-btn-"+a.data.id).click(function(t){t.preventDefault();var e=jQuery(this).siblings("#wpec-coupon-field-"+a.data.id).val();if(""===e)return!1;var n=jQuery(this),r=n.find("svg");n.prop("disabled",!0),r.show();var i={action:"wpec_check_coupon",product_id:a.data.product_id,coupon_code:e,curr:a.data.currency};jQuery.post(ppecFrontVars.ajaxUrl,i,function(t){if(t.success){a.data.discount=t.discount,a.data.discountType=t.discountType,a.data.couponCode=t.code,jQuery("#wpec-coupon-info-"+a.data.id).html('<span class="wpec_coupon_code">'+t.discountStr+'</span> <button class="wpec_coupon_apply_btn" id="wpec-remove-coupon-'+a.data.id+'" title="'+ppecFrontVars.str.strRemoveCoupon+'">'+ppecFrontVars.str.strRemove+"</button>"),jQuery("#wpec-redeem-coupon-btn-"+a.data.id).hide(),jQuery("#wpec-coupon-field-"+a.data.id).hide();var e,i,o,d,c=a.getPriceContainer();0!==c.find(".wpec_price_full_total").length?(e=c.children().find("span.wpec_tot_current_price").addClass("wpec_line_through"),i=c.children().find("span.wpec_tot_new_price")):(e=c.find("span.wpec_price_amount").addClass("wpec_line_through"),i=c.find("span.wpec_new_price_amount")),o=c.find("span.wpec-price-amount").addClass("wpec_line_through"),d=c.find("span.wpec-new-price-amount"),a.validateOrder(),jQuery("#wpec-remove-coupon-"+a.data.id).on("click",function(t){t.preventDefault(),jQuery("#wpec-coupon-info-"+a.data.id).html(""),jQuery("#wpec-coupon-field-"+a.data.id).val(""),jQuery("#wpec-coupon-field-"+a.data.id).show(),jQuery("#wpec-redeem-coupon-btn-"+a.data.id).show(),e.removeClass("wpec_line_through"),o.removeClass("wpec_line_through"),i.html(""),d.html(""),delete a.data.discount,delete a.data.discountType,delete a.data.couponCode,delete a.data.discountAmount,delete a.data.newPrice,a.validateOrder()})}else jQuery("#wpec-coupon-info-"+a.data.id).html(t.msg);r.hide(),n.prop("disabled",!1)})}),jQuery("#wpec-coupon-field-"+a.data.id).keydown(function(t){if(13===t.keyCode)return t.preventDefault(),jQuery("#wpec-redeem-coupon-btn-"+a.data.id).click(),!1}),a.validateOrder(),a.data.errors){var n=jQuery('<div class="wp-ppec-form-error-msg">'+a.data.errors+"</div>");a.scCont.append(n),n.show()}jQuery(".wpec-button-placeholder").remove()},onClick:function(){jQuery("#place-order-"+a.data.id).find("button>svg").show(),jQuery("#place-order-"+a.data.id).find("button").attr("disabled",!0),a.displayErrors();var t=a.scCont.find(".hasError").first();t.length>0?(t.focus(),t.trigger("change"),jQuery("#place-order-"+a.data.id).find("button>svg").hide(),jQuery("#place-order-"+a.data.id).find("button").attr("disabled",!1)):a.data.total||a.processPayment({payer:{name:{given_name:jQuery("#wpec_billing_first_name-"+a.data.id).val(),surname:jQuery("#wpec_billing_last_name-"+a.data.id).val()},email_address:jQuery("#wpec_billing_email-"+a.data.id).val(),address:{address_line_1:jQuery("#wpec_billing_address-"+a.data.id).val(),admin_area_1:jQuery("#wpec_billing_state-"+a.data.id).val(),admin_area_2:jQuery("#wpec_billing_city-"+a.data.id).val(),postal_code:jQuery("#wpec_billing_postal_code-"+a.data.id).val(),country_code:jQuery("#wpec_billing_country-"+a.data.id).val()},shipping_address:{address_line_1:jQuery("#wpec_shipping_address-"+a.data.id).val(),admin_area_1:jQuery("#wpec_shipping_state-"+a.data.id).val(),admin_area_2:jQuery("#wpec_shipping_city-"+a.data.id).val(),postal_code:jQuery("#wpec_shipping_postal_code-"+a.data.id).val(),country_code:jQuery("#wpec_shipping_country-"+a.data.id).val()}}},"wpec_process_empty_payment")},createOrder:async function(t,e){a.calcTotal();let n=(a.data.price*a.data.quantity).toFixed(2),r=parseFloat(n),i="NO_SHIPPING";""===a.data.shipping&&!0!==a.data.shipping_enable||(console.log("The physical product checkbox is enabled or there is shipping value has been configured. Setting the shipping preference to collect shipping."),i="GET_FROM_FILE");var o={intent:"CAPTURE",payment_source:{paypal:{experience_context:{payment_method_preference:"IMMEDIATE_PAYMENT_REQUIRED",shipping_preference:i,user_action:"PAY_NOW"}}},purchase_units:[{amount:{value:a.data.total,currency_code:a.data.currency,breakdown:{item_total:{currency_code:a.data.currency,value:r}}},items:[{name:a.data.name,quantity:a.data.quantity,unit_amount:{value:a.data.price,currency_code:a.data.currency}}]}]};a.data.tax&&(o.purchase_units[0].amount.breakdown.tax_total={currency_code:a.data.currency,value:a.PHP_round(a.data.tax_amount*a.data.quantity,a.data.dec_num)},o.purchase_units[0].items[0].tax={currency_code:a.data.currency,value:a.data.tax_amount}),a.data.shipping&&(o.purchase_units[0].amount.breakdown.shipping={currency_code:a.data.currency,value:a.getTotalShippingCost()}),a.data.discount&&(o.purchase_units[0].amount.breakdown.discount={currency_code:a.data.currency,value:parseFloat(a.data.discountAmount)}),console.log("Order data: "+JSON.stringify(o));let d=wpec_create_order_vars.nonce,c=a.data;console.log("WPEC data for create-order: "+JSON.stringify(c));let p="action=wpec_pp_create_order&data="+encodeURIComponent(JSON.stringify(o))+"&wpec_data="+encodeURIComponent(JSON.stringify(c))+"&_wpnonce="+d;try{const t=await fetch(ppecFrontVars.ajaxUrl,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:p}),a=await t.json();if(a.order_id)return console.log("Create-order API call to PayPal completed successfully."),a.order_id;{const t=a.err_msg;throw console.error("Error occurred during create-order call to PayPal. "+t),new Error(t)}}catch(t){console.error(t.message),alert("Could not initiate PayPal Checkout...\n\n"+t.message)}},onApprove:async function(t,e){jQuery('div.wp-ppec-overlay[data-ppec-button-id="'+a.data.id+'"]').css("display","flex"),console.log("Setting up the AJAX request for capture-order call.");let n={};n.order_id=t.orderID;let r=a.data,i=wpec_on_approve_vars.nonce,o="action=wpec_pp_capture_order&data="+encodeURIComponent(JSON.stringify(n))+"&wpec_data="+encodeURIComponent(JSON.stringify(r))+"&_wpnonce="+i;try{const t=await fetch(ppecFrontVars.ajaxUrl,{method:"post",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o}),e=await t.json();console.log("Capture-order API call to PayPal completed successfully."),a.completePayment(e)}catch(t){console.error(t),alert("PayPal returned an error! Transaction could not be processed. Enable the debug logging feature to get more details...\n\n"+JSON.stringify(t))}},onError:function(t){jQuery("#place-order-"+a.data.id).find("button>svg").hide(),jQuery("#place-order-"+a.data.id).find("button").attr("disabled",!1),alert(t)}},this.formatMoney=function(t){var e=isNaN(e=Math.abs(a.data.dec_num))?2:a.data.dec_num,n=a.data.dec_sep||".",r=a.data.thousand_sep||",",i=t<0?"-":"",o=String(parseInt(t=Math.abs(Number(t)||0).toFixed(e))),d=o.length,c=d>3?d%3:0,p=i+(c?o.substr(0,c)+r:"")+o.substr(c).replace(/(\d{3})(?=\d)/g,"$1"+r)+(e?n+Math.abs(t-o).toFixed(e).slice(2):"");return{left:"{symbol}{price}",left_space:"{symbol} {price}",right:"{price}{symbol}",right_space:"{price} {symbol}"}[a.data.curr_pos].replace("{symbol}",a.data.currency_symbol).replace("{price}",p)},this.getPriceContainer=function(){return jQuery("."+a.scCont.data("price-class"))},this.updateAllAmounts=function(){a.calcTotal();var t=a.getPriceContainer();if(t.length>0){var e=t.find(".wpec-price-amount");e.length>0&&e.html(a.formatMoney(a.data.price)),a.data.quantity>1?(t.find(".wpec-quantity").show(),t.find(".wpec-quantity-val").html(a.data.quantity)):t.find(".wpec-quantity").hide();var n=t.find(".wpec_tot_current_price"),r=t.find(".wpec_tot_new_price"),i=t.find(".wpec-new-price-amount"),o=t.find(".wpec_price_shipping_amount");void 0!==a.data.discountAmount?(i.html(a.formatMoney(a.data.newPrice)),r.html(a.formatMoney(a.data.total)),n.html(a.formatMoney(a.data.subtotal))):n.length>0&&n.html(a.formatMoney(a.data.total)),o.html(a.formatMoney(a.getTotalShippingCost()));var d=t.find(".wpec-tax-val");d.length>0&&d.html(a.formatMoney(a.data.tax_amount*a.data.quantity))}jQuery(document).trigger("wpec_after_update_all_amounts",[a])},this.calcTotal=function(){var e=parseFloat(a.data.price),n=parseInt(a.data.quantity),r=e*n;let i=r.toFixed(2);var o=r=parseFloat(i);if(a.data.newPrice=e,void 0!==a.data.discount){var d=0;(d="perc"===a.data.discountType?a.PHP_round(r*a.data.discount/100,a.data.dec_num):t.discount)>r&&(d=r),r-=d,a.data.discountAmount=a.PHP_round(d,a.data.dec_num),a.data.newPrice=a.PHP_round(e-d/n,a.data.dec_num)}if(a.data.tax){var c=a.PHP_round(r/n*a.data.tax/100,a.data.dec_num);a.data.tax_amount=c,r+=c*a.data.quantity,o+=a.PHP_round(o/n*a.data.tax/100,a.data.dec_num)*a.data.quantity}const p=a.getTotalShippingCost();p&&(r+=parseFloat(p),o+=parseFloat(p)),a.data.total=a.PHP_round(r,a.data.dec_num),a.data.subtotal=a.PHP_round(o,a.data.dec_num)},this.PHP_round=function(t,a){return Math.round(t*Math.pow(10,a))/Math.pow(10,a)},this.applyVariations=function(t){var e;if(a.data.variations.applied)for(e=0;e<a.data.variations.applied.length;++e){var n=a.data.variations[e];t+=parseFloat(n.prices[a.data.variations.applied[e]])}return a.PHP_round(t,a.data.dec_num)},this.getTotalShippingCost=function(){let t=0;const e=a.data.quantity?parseInt(a.data.quantity):1;return t=(a.data.shipping?parseFloat(a.data.shipping):0)+(a.data.shipping_per_quantity?parseFloat(a.data.shipping_per_quantity):0)*e,t=parseFloat(t.toFixed(2))},jQuery(document).trigger("wpec_before_render_button",[this]),paypal.Buttons(this.buttonArgs).render("#"+a.data.id)},wpecModal=function(t){var a=!1;function e(t){a=t=t||a;var e=document.getElementById(t);e.classList.toggle("wpec-opacity-0"),e.classList.toggle("wpec-pointer-events-none")}t(".wpec-modal-open, .wpec-modal-overlay, .wpec-modal-close").on("click",function(a){a.preventDefault(),e(t(this).data("wpec-modal"))}),document.onkeydown=function(t){("key"in(t=t||window.event)?"Escape"===t.key||"Esc"===t.key:27===t.keyCode)&&a&&e()},t(".wpec-custom-number-input button").on("click",function(){var a="increment"===t(this).data("action")?1:-1,e=t(this).parent().find("input"),n=e.attr("step")?Number(e.attr("step")):1;e.val(Number(e.val())+a*n).change()}),t("#wpec-sort-by").change(function(){t("#wpec-sort-by-form").submit()})};jQuery(wpecModal);